# 石門水庫集水區降雨逕流模擬 (水筒模式)

這是一個前端網頁應用程式，用於模擬石門水庫集水區的降雨逕流歷程。它採用了經典的水筒模式（Tank Model），並提供了一個互動式的圖形化介面，讓使用者可以視覺化觀測資料、手動調整模式參數、執行模擬，甚至使用 RPROP 演算法自動校正參數。

## 主要功能

- **資料視覺化**：以互動式圖表展示降雨與流量的時間序列資料。
- **參數互動**：提供介面讓使用者手動調整水筒模式的11個主要參數。
- **即時模擬**：點擊「執行演算」按鈕，立即使用當前參數進行模擬，並在圖表上繪製模擬流量歷線。
- **自動校正**：
    - 使用 **RPROP (Resilient Backpropagation)** 演算法自動尋找最佳參數組合。
    - 可選擇不同的目標函數進行最佳化，如 **RMSE** (均方根誤差)、**NSE** (納什效率係數) 或 **尖峰流量誤差**。
    - 提供校正過程的收斂圖，並可下載詳細的校正歷程。
- **資料編輯與匯出**：
    - 可直接在表格中編輯觀測的降雨與流量資料。
    - 將圖表匯出為 PNG 圖片。
    - 將詳細數據匯出為 CSV 檔案。
- **參數管理**：
    - 將當前參數儲存至瀏覽器快取 (localStorage)。
    - 從 JSON 檔案載入參數或將當前參數下載為 JSON 檔案。
- **歷史事件快速導覽**：快速跳轉至當年度最高流量或最高日雨量的事件日期。

## 水筒模式計算步驟

水筒模式將集水區抽象為兩個垂直堆疊的儲水筒（上層與下層），模擬雨水如何轉化為不同層次的逕流。以下為每個時間步（time step）的計算流程：

#### 狀態變數
- `HTank1`: 上層水筒的目前水深 (mm)
- `HTank2`: 下層水筒的目前水深 (mm)

#### 輸入
- `P`: 該時段的降雨量 (mm)
- `tankpm`: 包含所有模型參數的物件
- `timeIntervSeconds`: 時間步長（秒），此專案中為 3600 秒（1小時）

---

### 1. 上層水筒計算

1.  **加入降雨**：
    `HTank1 = HTank1 + P`

2.  **計算潛在流出量**：
    - **表面逕流 (Q1)**：當水深超過第一個出水口高度 `h1` 時產生。
      `Q1 = a1 * (HTank1 - h1)`
    - **中間流 (Q2)**：當水深超過第二個出水口高度 `h2` 時產生。
      `Q2 = a2 * (HTank1 - h2)`
    - **向下層滲漏 (Q3)**：只要水筒中有水就會發生。
      `Q3 = a3 * HTank1`

3.  **水量平衡校核**：
    - 總潛在流出量 `upperOutflow = Q1 + Q2 + Q3`。
    - 如果 `upperOutflow > HTank1`（流出大於現有水量），則按比例縮減所有流出項，確保水量守恆。

4.  **更新上層水筒水位**：
    `HTank1 = HTank1 - (Q1 + Q2 + Q3)`

5.  **計算上層總逕流量**：
    `Q_upper = Q1 + Q2`

---

### 2. 下層水筒計算

1.  **接收上層滲漏**：
    `HTank2 = HTank2 + Q3`

2.  **計算潛在流出量**：
    - **地下逕流 (Q4)**：當水深超過出水口高度 `h3` 時產生。
      `Q4 = b1 * (HTank2 - h3)`
    - **基流 (Q5)**：只要水筒中有水就會發生。
      `Q5 = b2 * HTank2`
    - **深層滲漏/損失 (Q6)**：視為流出系統的損失。
      `Q6 = b3 * HTank2`

3.  **水量平衡校核**：
    - 總潛在流出量 `lowerOutflow = Q4 + Q5 + Q6`。
    - 如果 `lowerOutflow > HTank2`，則按比例縮減所有流出項。

4.  **更新下層水筒水位**：
    `HTank2 = HTank2 - (Q4 + Q5 + Q6)`

5.  **計算下層總逕流量**：
    `Q_lower = Q4 + Q5`

---

### 3. 總逕流量計算

1.  **合計總逕流量 (mm)**：
    `totalRunoff_mm = Q_upper + Q_lower`

2.  **單位換算為 CMS (立方公尺/秒)**：
    將集水區的逕流深度 (mm) 轉換為體積，再除以時間步長，得到平均流量。
    `runoff_cms = (totalRunoff_mm / 1000) * (area * 1e6) / timeIntervSeconds`

此 `runoff_cms` 即為該時間步的模擬流量值。

## 技術堆疊

- **HTML5 / CSS3**
- **Bootstrap 5**：用於快速建構響應式介面。
- **JavaScript (ES6 Modules)**：核心應用程式邏輯。
- **jQuery**：用於簡化 DOM 操作及 AJAX 請求。
- **Flot Charts**：用於繪製互動式歷線圖。

## 如何使用

1.  確保您的電腦上安裝了網頁伺服器環境（例如 VS Code 的 Live Server 擴充套件）。
2.  將整個專案資料夾放置在伺服器的根目錄下。
3.  透過瀏覽器訪問 `index.html`。

---
*版權所有© 2025 多采科技有限公司*
